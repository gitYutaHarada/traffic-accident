# Phase 1: データ準備と前処理 - 設計決定と根拠

本ドキュメントは、`honhyo_clean_with_features.csv` を作成するにあたり行ったデータ前処理の設計決定とその根拠を説明します。

---

## 1. データ収集と統合

### 実施内容
- 警察庁オープンデータサイトから2019〜2024年（6年分）のCSVをダウンロード
- Pandasで1つのデータフレームに結合 → 約**189万件**

### 根拠
- 十分なサンプルサイズを確保するため、複数年のデータを統合
- 年ごとの傾向変化を捉えるため、複数年度のデータが必要

---

## 2. データクリーニング

### 2.1 データリーク列の除外（14列）

| 除外した列 | 理由 |
|-----------|------|
| `事故内容` | 死亡/負傷の区分そのもの（100%リーク） |
| `人身損傷程度（当事者A/B）` | 事故後にしか判明しない情報 |
| `負傷者数` | 目的変数に直接関連 |
| `車両の損壊程度（当事者A/B）` | 衝突の重大性を示す事後情報 |
| `車両の衝突部位（当事者A/B）` | 事故後に調査される情報 |
| `エアバッグの装備（当事者A/B）` | 作動状況が含まれる可能性 |
| `サイドエアバッグの装備（当事者A/B）` | 同上 |
| `資料区分`, `本票番号` | 管理情報（予測に無関係） |

### 根拠
> [!CAUTION]
> **データリーク（Data Leakage）** とは、予測時に利用不可能な情報がモデル学習時に混入し、虚偽の高精度を示す現象。上記の列は**事故発生後に初めて判明する情報**であり、事故発生前に予測するモデルでは使用不可。

### 2.2 事故類型の除外

| 除外した列 | 理由 |
|-----------|------|
| `事故類型` | 「人対車両」「車両相互」等の分類は**事故発生後に確定**する情報であり、事前予測には使用不可 |

---

## 3. 特徴量エンジニアリング

### 3.1 日時データの分解

| 派生変数 | 派生元 | 根拠 |
|---------|--------|------|
| `year` | `発生日時` | 年ごとのトレンド変化を捉える（過去実験で有効性確認済み） |
| `month` | `発生日時` | 季節性（夏/冬の事故傾向差）を捉える |
| `day` | `発生日時` | 月末効果等を捉える可能性 |
| `hour` | `発生日時` | 時間帯別リスク（深夜の居眠り運転等）を捉える |

### 根拠
- `発生日時` はdatetime型のため、ほとんどのMLモデルが直接扱えない
- 分解後はカテゴリカル変数として効果的に学習可能
- **元の`発生日時`列は冗長となるため削除**

### 3.2 地理情報のクラスタリング（Geo-Clustering）

| 派生変数 | 手法 | 根拠 |
|---------|------|------|
| `area_id` | MiniBatchKMeans (n=50) | 緯度経度を直接使うと過学習しやすいため、日本全ほう50エリアに分割してカテゴリ化 |

### 根拠
- 緯度経度は連続値であり、そのまま使うと特定の座標に過学習するリスクがある
- クラスタリングにより「地域」という抽象的な概念に変換
- 過去実験で**Feature Importance 1位**を獲得した有効な変数

### 3.3 道路種別の派生（`road_type`）

#### 元のカラム: `路線コード`
コードブックによると、`路線コード` は5桁の数値で、上4桁が路線種別、下1桁がバイパス区間を示す。

**元データの例**:
| 路線コード | 意味 |
|----------:|------|
| 00010 | 国道1号（現道区間） |
| 00011 | 国道1号（バイパス区間1） |
| 12340 | 主要地方道（都道府県道） |
| 40010 | 高速自動車国道（東名高速等） |
| 95000 | その他 |

**問題点**:
- ユニーク値が約6800種類と非常に多い
- バイパス区間の違いは死亡事故予測に大きな影響を与えにくい
- 細かすぎるカテゴリは過学習の原因になる

#### 変換後: `road_type`
上4桁のコード範囲に基づき、15種類の道路種別に集約。

| road_type | コード範囲 | 意味 |
|:---------:|-----------|------|
| 0 | 0001〜0999 | 一般国道 |
| 1 | 1000〜1499 | 主要地方道（都道府県道） |
| 2 | 1500〜1999 | 主要地方道（市道） |
| 3 | 2000〜2999 | 一般都道府県道 |
| 4 | 3000〜3999 | 一般市町村道 |
| 5 | 4000〜4999 | 高速自動車国道 |
| 6 | 5000〜5499 | 自動車専用道（指定） |
| 7 | 5500〜5999 | 自動車専用道（その他） |
| 8 | 6000〜6999 | 道路運送法上の道路 |
| 9 | 7000〜7999 | 農道 |
| 10 | 8000〜8499 | 林道 |
| 11 | 8500〜8999 | 港湾道 |
| 12 | 9000〜9499 | 私道 |
| 13 | 9500 | その他 |
| 14 | 9900 | 一般の交通の用に供するその他の道路 |

#### 根拠
1. **次元削減**: 約6800種類 → 15種類に集約し、過学習リスクを低減
2. **解釈性向上**: 「国道」「高速道路」「市町村道」等の意味のあるカテゴリに変換
3. **ドメイン知識の反映**: 道路種別ごとの交通量・速度制限の違いは死亡事故リスクに影響する可能性が高い
4. **元の路線コードは削除**: 情報は`road_type`に集約されているため冗長

---

## 4. 目的変数の作成

### 定義
- **`死者数`** 列を使用
- `y = 1`：死亡事故（死者数 ≥ 1）
- `y = 0`：非死亡事故（死者数 = 0）

### 根拠
- 「事故内容」列は事後情報としてリーク対象のため使用不可
- 「死者数」列は目的変数として事前に定義された変数であり、リークには該当しない

### クラス不均衡
| クラス | 件数 | 割合 |
|--------|-----:|-----:|
| 非死亡事故 | 1,879,008 | 99.14% |
| 死亡事故 | 16,267 | 0.86% |

> **不均衡比**: 約 **118:1** → SMOTE、Class Weight等の対策が必要

---

## 5. 最終データセット構成

### ファイル
`data/processed/honhyo_clean_with_features.csv`

### カラム数
- 元データ: 50列
- 除外後: 36列
- 派生変数追加後: 約35列（発生日時削除、year/month/day/hour/area_id追加）

### 使用しない列（モデル学習時に除外推奨）
| 列 | 理由 |
|----|------|
| `地点　経度（東経）` | area_idに集約済み |
| `地点　緯度（北緯）` | 同上 |
| `地点コード` | 直轄国道以外は0のため情報量が少ない |

---

## 関連ファイル

| ファイル | 内容 |
|----------|------|
| [add_derived_features.py](file:///c:/Users/socce/4nd%20year/software%20labratory/0.オープンデータを用いた交通事故原因分析/オープンデータ/scripts/data_processing/add_derived_features.py) | 派生変数追加スクリプト |
| [create_clean_dataset.py](file:///c:/Users/socce/4nd%20year/software%20labratory/0.オープンデータを用いた交通事故原因分析/オープンデータ/scripts/data_processing/create_clean_dataset.py) | リーク列除外スクリプト |
| [COLUMN_DEFINITIONS.md](file:///c:/Users/socce/4nd%20year/software%20labratory/0.オープンデータを用いた交通事故原因分析/オープンデータ/data/processed/COLUMN_DEFINITIONS.md) | カラム定義書 |
