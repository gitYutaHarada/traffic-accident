# 変数型分析結果（実データ検証済み）

## データセット: honhyo_clean_predictable_only.csv
- **データ行数**: 1,895,275
- **全カラム数**: 33

---

## ✅ 分析結果サマリー

| 分類 | カラム数 | 割合 |
|-----|---------|------|
| **カテゴリカル変数** | 27 | 81.8% |
| **数値変数** | 3 | 9.1% |
| **目的変数** | 1 | 3.0% |
| **その他（要変換）** | 2 | 6.1% |

---

## 📋 LightGBM用 カテゴリカル変数リスト（27個）

```python
categorical_features = [
    'ゾーン規制',                           # 2値
    '一時停止規制　標識（当事者A）',        # 10値
    '一時停止規制　標識（当事者B）',        # 10値
    '一時停止規制　表示（当事者A）',        # 4値
    '一時停止規制　表示（当事者B）',        # 4値
    '中央分離帯施設等',                      # 8値
    '事故類型',                              # 4値
    '信号機',                                # 8値
    '地形',                                  # 3値
    '天候',                                  # 5値
    '昼夜',                                  # 6値
    '曜日(発生年月日)',                     # 7値
    '祝日(発生年月日)',                     # 4値
    '歩車道区分',                            # 4値
    '路面状態',                              # 5値
    '車道幅員',                              # 16値
    '道路形状',                              # 12値
    '道路線形',                              # 10値
    '路線コード',                            # 2,986値 ⚠️
    '年齢（当事者A）',                      # 8値
    '当事者種別（当事者A）',                # 31値
    '用途別（当事者A）',                    # 4値
    '速度規制（指定のみ）（当事者A）',      # 14値
    '速度規制（指定のみ）（当事者B）',      # 13値
    '市区町村コード',                        # 353値 ⚠️
    '警察署等コード',                        # 282値 ⚠️
    '都道府県コード',                        # 51値
]
```

### カテゴリカル変数のインデックスリスト
```python
categorical_indices = [0, 1, 2, 3, 4, 5, 6, 7, 8, 12, 16, 17, 21, 18, 25, 26, 29, 30, 24, 14, 15, 20, 27, 28, 13, 23, 31]
```

---

## 🔢 数値変数リスト（3個）

```python
numerical_features = [
    '地点　経度（東経）',  # int64, 範囲: 0 ~ 1,454,811 (度分秒形式)
    '地点　緯度（北緯）',  # int64, 範囲: 0 ~ 453,103 (度分秒形式)
    '地点コード',         # int64, 75%が0, max=9,999
]
```

⚠️ **注意**: 緯度経度は度分秒形式（例: 351026=35度10分26秒）のため、度に変換推奨

---

## 🎯 目的変数

```python
target = '死者数'  # 0=負傷のみ, 1=死亡
```

### クラス分布
| 値 | 件数 | 割合 |
|----|------|------|
| **0 (負傷)** | 1,879,008 | **99.14%** |
| **1 (死亡)** | 16,267 | **0.86%** |

**不均衡比率**: 約 **115:1**

---

## ⚠️ 重要な注意事項

### 1. 高カーディナリティ変数
以下の変数はユニーク値が多いため取り扱い注意：

| 変数 | ユニーク値数 | 対策 |
|-----|-------------|------|
| `路線コード` | 2,986 | 上位コード（道路種別）のみ使用検討 |
| `市区町村コード` | 353 | そのまま使用可（中程度） |
| `警察署等コード` | 282 | そのまま使用可（中程度） |

### 2. クラス不均衡対策
**必須**: 115:1の不均衡に対処が必要
- `scale_pos_weight = 115` をLightGBMに設定
- または SMOTE/アンダーサンプリング

### 3. その他の変数（要変換）
- `発生日時`: 文字列型 → 時間帯/曜日/月などに特徴量エンジニアリング
- `衝突地点`: カテゴリカル変数として扱える（3値）

---

## 📝 LightGBMモデル作成時の推奨設定

```python
import lightgbm as lgb

params = {
    'objective': 'binary',
    'metric': 'auc',
    'boosting_type': 'gbdt',
    
    # クラス不均衡対策
    'scale_pos_weight': 115,  # (負傷数 / 死亡数)
    'is_unbalance': True,
    
    # カテゴリカル変数の指定方法（2つの方法）
    # 方法1: インデックスで指定
    'categorical_feature': [0, 1, 2, 3, 4, 5, 6, 7, 8, 12, 16, 17, 21, 18, 25, 26, 29, 30, 24, 14, 15, 20, 27, 28, 13, 23, 31],
    
    # 方法2: カラム名で指定（推奨）
    # 'categorical_feature': 'auto',  # データ型から自動判別
    
    # その他のパラメータ
    'num_leaves': 31,
    'max_depth': -1,
    'learning_rate': 0.05,
    'n_estimators': 1000,
    'min_child_samples': 20,
    'verbosity': -1,
}
```

---

## 💡 次のステップ

1. ✅ 変数型の分類完了
2. ⏭️ 特徴量エンジニアリング（発生日時の分解、緯度経度の変換）
3. ⏭️ LightGBMモデルの作成とクラス不均衡対策
4. ⏭️ Stratified K-Fold交差検証
5. ⏭️ モデル評価（Recall、Precision、AUC）
