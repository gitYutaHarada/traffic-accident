# クリーンデータセット作成完了レポート

**作成日時:** 2025年12月8日  
**作成者:** Antigravity  
**目的:** データリークを完全に防止したクリーンな学習用データセットの作成

---

## ✅ 作成完了

### 新しいクリーンデータセット

**ファイル名**: `honhyo_clean_no_leakage.csv`  
**パス**: [data/processed/honhyo_clean_no_leakage.csv](file:///c:/Users/socce/software-lab/traffic-accident/data/processed/honhyo_clean_no_leakage.csv)

**データ仕様**:
- **行数**: 1,895,275行
- **列数**: 36列（元データ50列から14列を除外）
- **サイズ**: 約●●MB
- **エンコーディング**: UTF-8 with BOM

---

## 🛡️ データリーク防止対策

### 除外した事後情報列（14列）

以下の列は**事故発生後にのみわかる情報**であるため、完全に除外されました：

| # | 列名 | リーク度 | 理由 |
|---|------|----------|------|
| 1 | **事故内容** | **🔴 極めて高** | 死亡/負傷の区分そのもの（100%リーク） |
| 2 | 人身損傷程度（当事者A） | 🔴 極めて高 | 死亡・重傷・軽傷の区分 |
| 3 | 人身損傷程度（当事者B） | 🔴 極めて高 | 同上 |
| 4 | 負傷者数 | 🔴 極めて高 | 事故の重大性に直接関連 |
| 5 | 車両の損壊程度（当事者A） | 🟠 高 | 衝突の重大性を示す |
| 6 | 車両の損壊程度（当事者B） | 🟠 高 | 同上 |
| 7 | 車両の衝突部位（当事者A） | 🟡 中 | 事故後の情報 |
| 8 | 車両の衝突部位（当事者B） | 🟡 中 | 同上 |
| 9 | エアバッグの装備（当事者A） | 🟢 低（予防的除外） | 作動状況が含まれる可能性 |
| 10 | エアバッグの装備（当事者B） | 🟢 低（予防的除外） | 同上 |
| 11 | サイドエアバッグの装備（当事者A） | 🟢 低（予防的除外） | 同上 |
| 12 | サイドエアバッグの装備（当事者B） | 🟢 低（予防的除外） | 同上 |
| 13 | 資料区分 | - | 管理情報（予測に無関係） |
| 14 | 本票番号 | - | ID情報（予測に無関係） |

### 検証済み

✅ **除外前検証**: 14/14列がデータに存在することを確認  
✅ **除外実行**: 14列を正常に除外  
✅ **除外後検証**: 事後情報列が残っていないことを確認  
✅ **保存後検証**: 保存されたデータに事後情報列が含まれていないことを再確認

---

## 📊 残存した特徴量（36列）

### 事前に観測可能な特徴量

クリーンデータセットには、**事故発生前または発生時に観測可能な情報**のみが含まれています：

**環境・時間情報**:
- 発生日時（年月日時分）
- 曜日、祝日フラグ
- 昼夜
- 天候
- 路面状態
- 地形

**道路・地点情報**:
- 都道府県コード
- 市区町村コード
- 警察署等コード
- 路線コード
- 地点コード
- 地点 経度（東経）
- 地点 緯度（北緯）
- 道路形状
- 道路線形
- 車道幅員
- 信号機の有無
- 一時停止規制（標識・表示）
- 中央分離帯施設等
- 歩車道区分
- 衝突地点
- ゾーン規制

**当事者情報**:
- 当事者種別（A・B）
- 年齢（A・B）
- 用途別（A・B）
- 速度規制（指定のみ）（A・B）

**事故分類**:
- 事故類型
- **死者数（目的変数）**

---

## 🎯 目的変数の分布

```
死者数  件数
0       1,879,008  (99.14%)  ← 非死亡事故
1          15,929  (0.84%)   ← 1名死亡
2             309  (0.02%)   ← 2名死亡
3              23  (0.001%)  ← 3名死亡
4               4  (0.0002%) ← 4名死亡
5               2  (0.0001%) ← 5名死亡
```

**クラス不均衡比**: 約118:1（非死亡:死亡1名以上）

---

## 🔧 使用方法

### 基本的な読み込み

```python
import pandas as pd

# クリーンデータセットの読み込み
df = pd.read_csv('data/processed/honhyo_clean_no_leakage.csv')

# 特徴量と目的変数の分離
X = df.drop(columns=['死者数'])
y = df['死者数']

# 二値分類の場合
y_binary = (y > 0).astype(int)  # 死亡事故か否か
```

### 注意事項

> [!IMPORTANT]
> このデータセットを使用する際は、以下の点に注意してください：
>
> 1. **カテゴリカル変数の処理**: 多くの列が数値コードで表現されていますが、カテゴリカル変数として扱う必要があります
> 2. **欠損値の処理**: 一部の列には欠損値が含まれています
> 3. **クラス不均衡**: 死亡事故は全体の約1%のため、適切な対策（SMOTE、重み付けなど）が必要です
> 4. **地理情報**: 経度・緯度を使用する場合は適切な前処理が必要です

---

## 📁 関連ファイル

### スクリプト
- [create_clean_dataset.py](file:///c:/Users/socce/software-lab/traffic-accident/scripts/data_processing/create_clean_dataset.py) - データ作成スクリプト

### データ
- **入力**: `honhyo_all/csv/honhyo_all_with_datetime.csv` (元データ)
- **出力**: `data/processed/honhyo_clean_no_leakage.csv` (クリーンデータ)

### ドキュメント
- [comprehensive_data_leakage_audit.md](file:///c:/Users/socce/software-lab/traffic-accident/results/experiments/comprehensive_data_leakage_audit.md) - 全実験の監査レポート
- [data_leakage_investigation.md](file:///c:/Users/socce/software-lab/traffic-accident/results/experiments/data_leakage_investigation.md) - データリーク調査レポート

---

## ✅ 品質保証

### 検証項目

| 検証項目 | 結果 | 詳細 |
|---------|------|------|
| 事後情報列の除外 | ✅ 合格 | 14列すべて除外済み |
| 目的変数の存在 | ✅ 合格 | `死者数`列が存在 |
| データ件数 | ✅ 合格 | 1,895,275行（元データと一致） |
| エンコーディング | ✅ 合格 | UTF-8 with BOM |
| 読み込み可能性 | ✅ 合格 | pandasで正常に読み込み可能 |

---

## 📌 今後の推奨事項

1. **すべての実験でこのクリーンデータを使用**: 既存の実験スクリプトを更新してこのデータを参照
2. **ベースライン確立**: クリーンデータでの真の性能を測定
3. **特徴量エンジニアリング**: 事前情報のみから有用な特徴量を作成
4. **定期的な更新**: 新しい年のデータが追加された際は、同じ除外ロジックで再作成

---

## 🎓 学んだこと

1. **データリークの深刻性**: 事後情報が含まれると、モデルは虚偽の高性能を示す
2. **検証の重要性**: `errors='ignore'`は危険。除外後は必ずassertionで確認
3. **全角/半角の注意**: 日本語データでは括弧の種類に注意が必要
4. **透明性**: どの列をなぜ除外したかをドキュメント化することが重要
