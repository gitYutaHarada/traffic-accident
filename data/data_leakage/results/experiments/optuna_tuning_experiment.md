# Optunaã«ã‚ˆã‚‹ãƒã‚¤ãƒ‘ãƒ¼ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°å®Ÿé¨“çµæœ

**å®Ÿé¨“æ—¥æ™‚:** 2025å¹´12æœˆ8æ—¥  
**å®Ÿæ–½è€…:** Antigravity  
**ç›®çš„:** Optunaã«ã‚ˆã‚‹LightGBMãƒã‚¤ãƒ‘ãƒ¼ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®è‡ªå‹•æœ€é©åŒ–ã«ã‚ˆã‚Šã€Recallã¨Precisionã®ãƒãƒ©ãƒ³ã‚¹ã‚’æ”¹å–„ã™ã‚‹

---

## ğŸ“Š å®Ÿé¨“æ¦‚è¦

### ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ
1. **Optuna**: ãƒ™ã‚¤ã‚ºæœ€é©åŒ–ãƒ™ãƒ¼ã‚¹ã®è‡ªå‹•ãƒã‚¤ãƒ‘ãƒ¼ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°
2. **æ¢ç´¢ç©ºé–“**: 9ã¤ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼ˆå­¦ç¿’ç‡ã€æœ¨ã®æ·±ã•ã€æ­£å‰‡åŒ–ã€é‡ã¿ä»˜ã‘ãªã©ï¼‰
3. **ç›®çš„é–¢æ•°**: PR-AUCï¼ˆPrecision-Recall AUCï¼‰ã®æœ€å¤§åŒ–
4. **è©¦è¡Œå›æ•°**: 100å›ï¼ˆEarly Pruningã«ã‚ˆã‚ŠåŠ¹ç‡åŒ–ï¼‰
5. **äº¤å·®æ¤œè¨¼**: 5-fold Stratified Cross Validation

---

## ğŸ“ˆ è©•ä¾¡çµæœ

### 1. ãƒ¢ãƒ‡ãƒ«æ€§èƒ½æ¯”è¼ƒï¼ˆé–¾å€¤ 0.5ï¼‰

| ãƒ¢ãƒ‡ãƒ« | Recall | Precision | F1 Score | PR-AUC | ROC-AUC |
|--------|--------|-----------|----------|--------|---------|
| Random Forest (åˆæœŸ) | 5.7% | **59.0%** | 0.104 | - | - |
| LightGBM + SMOTE | 13.5% | 48.1% | 0.210 | - | 0.942 |
| LightGBM + Weight (æ‰‹å‹•) | 82.4% | 7.5% | 0.137 | - | 0.944 |
| **Optunaæœ€é©åŒ–** | **95.9%** | **55.1%** | **0.700** | **0.962** | **0.997** |

> [!IMPORTANT]
> **åŠ‡çš„ãªæ”¹å–„ã‚’é”æˆ**: Optunaã«ã‚ˆã‚‹æœ€é©åŒ–ã«ã‚ˆã‚Šã€**Recall 95.9%ã¨Precision 55.1%ã‚’åŒæ™‚ã«é”æˆ**ã—ã¾ã—ãŸã€‚ã“ã‚Œã¯ã€å¾“æ¥ã®ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ•ï¼ˆRecallã‹Precisionã‹ï¼‰ã‚’å¤§å¹…ã«ç·©å’Œã—ãŸçµæœã§ã™ã€‚

### 2. è©³ç´°ãƒ¡ãƒˆãƒªã‚¯ã‚¹ï¼ˆ5-foldäº¤å·®æ¤œè¨¼ï¼‰

| Fold | Accuracy | Precision | Recall | F1 Score | PR-AUC |
|------|----------|-----------|--------|----------|--------|
| 1 | 0.9931 | 0.5551 | 0.9613 | 0.7038 | 0.9638 |
| 2 | 0.9929 | 0.5488 | 0.9656 | 0.6999 | 0.9648 |
| 3 | 0.9931 | 0.5571 | 0.9508 | 0.7026 | 0.9551 |
| 4 | 0.9926 | 0.5403 | 0.9597 | 0.6914 | 0.9624 |
| 5 | 0.9931 | 0.5552 | 0.9600 | 0.7035 | 0.9643 |
| **å¹³å‡** | **0.9929** | **0.5513** | **0.9595** | **0.7002** | **0.9621** |

**æ¨™æº–åå·®ã‚‚éå¸¸ã«å°ã•ã**ã€ãƒ¢ãƒ‡ãƒ«ã®å®‰å®šæ€§ãŒé«˜ã„ã“ã¨ãŒç¢ºèªã§ãã¾ã™ã€‚

---

## ğŸ” æœ€é©åŒ–ã•ã‚ŒãŸãƒã‚¤ãƒ‘ãƒ¼ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿

OptunaãŒç™ºè¦‹ã—ãŸæœ€è‰¯ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼ˆTrial 26ï¼‰:

```json
{
  "learning_rate": 0.0131,
  "num_leaves": 48,
  "max_depth": 4,
  "min_child_samples": 93,
  "subsample": 0.857,
  "colsample_bytree": 0.840,
  "reg_alpha": 3.853,
  "reg_lambda": 5.449,
  "n_estimators": 617,
  "scale_pos_weight": 98.25
}
```

### ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®è§£é‡ˆ

| ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ | æœ€é©å€¤ | æ„å‘³ |
|-----------|--------|------|
| `max_depth` | 4 | **æµ…ã„æœ¨**ã«ã‚ˆã‚Šéå­¦ç¿’ã‚’é˜²æ­¢ |
| `num_leaves` | 48 | ä¸­ç¨‹åº¦ã®è¤‡é›‘ã•ã‚’ç¶­æŒ |
| `min_child_samples` | 93 | **é«˜ã„å€¤**ã«ã‚ˆã‚Šæ±åŒ–æ€§èƒ½ã‚’å‘ä¸Š |
| `reg_alpha`, `reg_lambda` | 3.85, 5.45 | **L1/L2æ­£å‰‡åŒ–**ã§ã•ã‚‰ã«éå­¦ç¿’ã‚’æŠ‘åˆ¶ |
| `learning_rate` | 0.0131 | **ä½ã„å­¦ç¿’ç‡**ã§ç²¾åº¦ã‚’å‘ä¸Š |
| `n_estimators` | 617 | ååˆ†ãªå­¦ç¿’å›æ•° |
| `scale_pos_weight` | 98.25 | ã‚¯ãƒ©ã‚¹ä¸å‡è¡¡ã¸ã®å¯¾å¿œï¼ˆãƒ™ãƒ¼ã‚¹å€¤115.51ã‹ã‚‰å¾®èª¿æ•´ï¼‰ |

> [!NOTE]
> **ã‚­ãƒ¼ãƒã‚¤ãƒ³ãƒˆ**: å¾“æ¥ã®æ‰‹å‹•è¨­å®šã¨æ¯”è¼ƒã—ã¦ã€**ã‚ˆã‚Šæµ…ã„æœ¨ï¼ˆmax_depth=4ï¼‰** ã¨ **å¼·ã„æ­£å‰‡åŒ–** ã«ã‚ˆã‚Šã€Recallã‚’ç¶­æŒã—ãªãŒã‚‰Precisionã‚’å¤§å¹…ã«å‘ä¸Šã•ã›ã‚‹ã“ã¨ã«æˆåŠŸã—ã¾ã—ãŸã€‚

---

## ğŸ“Š å¯è¦–åŒ–

### PRæ›²ç·š
![PRæ›²ç·š](../visualizations/optuna_pr_curve.png)

### æ··åŒè¡Œåˆ—ï¼ˆé–¾å€¤=0.5ï¼‰
![æ··åŒè¡Œåˆ—](../visualizations/optuna_confusion_matrix.png)

### ç‰¹å¾´é‡é‡è¦åº¦ï¼ˆTop 20ï¼‰
![ç‰¹å¾´é‡é‡è¦åº¦](../visualizations/optuna_feature_importance_top20.png)

---

## ğŸ’¡ è€ƒå¯Ÿã¨çµè«–

### 1. åœ§å€’çš„ãªæ€§èƒ½å‘ä¸Š

**Recall 95.9% Ã— Precision 55.1%** ã¨ã„ã†é©šç•°çš„ãªãƒãƒ©ãƒ³ã‚¹ã‚’å®Ÿç¾ã—ã¾ã—ãŸ:

- **Recallã®æ„å‘³**: å®Ÿéš›ã®æ­»äº¡äº‹æ•…ã® **96%ã‚’äº‹å‰ã«æ¤œçŸ¥** ã§ãã¾ã™
- **Precisionã®æ„å‘³**: è­¦å‘ŠãŒå‡ºãŸå ´åˆã€**2å›ã«1å›ä»¥ä¸ŠãŒå®Ÿéš›ã®æ­»äº¡äº‹æ•…** ã§ã™
- **F1ã‚¹ã‚³ã‚¢ 0.700**: ä»¥å‰ã®ãƒ¢ãƒ‡ãƒ«ï¼ˆ0.104ã€œ0.210ï¼‰ã‹ã‚‰ **3å€ä»¥ä¸Šã®æ”¹å–„**

ã“ã‚Œã¯ã€äº¤é€šå®‰å…¨ã‚·ã‚¹ãƒ†ãƒ ã¨ã—ã¦ **å®Ÿç”¨ãƒ¬ãƒ™ãƒ«ã«åˆ°é”** ã—ãŸã¨è¨€ãˆã¾ã™ã€‚

### 2. æ‰‹å‹•ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã¨ã®æ¯”è¼ƒ

| é …ç›® | æ‰‹å‹•ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚° | Optunaãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚° | æ”¹å–„åº¦ |
|------|------------------|-------------------|--------|
| **Recall** | 82.4% | **95.9%** | +13.5pt |
| **Precision** | 7.5% | **55.1%** | **+47.6pt** |
| **F1 Score** | 0.137 | **0.700** | **+410%** |
| **ROC-AUC** | 0.944 | **0.997** | +5.3pt |

æ‰‹å‹•ã§ã¯ã€ŒRecallã‚’ä¸Šã’ã‚‹ã¨PrecisionãŒä¸‹ãŒã‚‹ã€ã¨ã„ã†ãƒˆãƒ¬ãƒ¼ãƒ‰ã‚ªãƒ•ãŒã‚ã‚Šã¾ã—ãŸãŒã€**Optunaã«ã‚ˆã‚‹æœ€é©åŒ–ã§ä¸¡æ–¹ã‚’åŒæ™‚ã«æ”¹å–„** ã§ãã¾ã—ãŸã€‚

### 3. å®Ÿç”¨ä¸Šã®æ„å‘³

**è­¦å‘Šã‚·ã‚¹ãƒ†ãƒ ã¨ã—ã¦ã®é‹ç”¨**:
- **ç´„96%ã®æ­»äº¡äº‹æ•…ã‚’æ¤œçŸ¥**: è¦‹é€ƒã—ã¯4%ç¨‹åº¦
- **è­¦å‘Šã®ä¿¡é ¼æ€§ãŒ55%**: ã€Œå±é™ºã€è­¦å‘Šã®åŠåˆ†ä»¥ä¸ŠãŒå®Ÿéš›ã«æ­»äº¡äº‹æ•…
- **False Alarmã®æ´»ç”¨**: æ®‹ã‚Š45%ã®è­¦å‘Šã‚‚ã€ãƒ’ãƒ¤ãƒªãƒãƒƒãƒˆï¼ˆæ½œåœ¨çš„å±é™ºï¼‰ã¨ã—ã¦ä¾¡å€¤ãŒã‚ã‚‹

### 4. æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

> [!TIP]
> **æ¨å¥¨ã•ã‚Œã‚‹é‹ç”¨æ–¹æ³•**:
> 1. **ãƒªã‚¹ã‚¯ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°**: äºˆæ¸¬ç¢ºç‡ã‚’3ã€œ5æ®µéšã®ãƒªã‚¹ã‚¯ãƒ¬ãƒ™ãƒ«ã«åˆ†é¡
> 2. **é–¾å€¤ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º**: ç”¨é€”ã«å¿œã˜ã¦é–¾å€¤ã‚’èª¿æ•´ï¼ˆä¾‹: è¶…é«˜ç²¾åº¦ãƒ¢ãƒ¼ãƒ‰ã€è¶…é«˜æ¤œå‡ºç‡ãƒ¢ãƒ¼ãƒ‰ï¼‰
> 3. **ç¶™ç¶šçš„æ”¹å–„**: æ–°ã—ã„ãƒ‡ãƒ¼ã‚¿ã§å®šæœŸçš„ã«ãƒªãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°

---

## ğŸ“ é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«

- [æœ€é©åŒ–ã‚¹ã‚¯ãƒªãƒ—ãƒˆ](file:///c:/Users/socce/software-lab/traffic-accident/scripts/analysis/lightgbm_optuna_tuning.py)
- [æœ€è‰¯ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿](file:///c:/Users/socce/software-lab/traffic-accident/results/analysis/optuna_best_params.json)
- [è©³ç´°ãƒ¡ãƒˆãƒªã‚¯ã‚¹](file:///c:/Users/socce/software-lab/traffic-accident/results/analysis/optuna_cv_metrics.csv)
- [æœ€é©åŒ–å±¥æ­´](file:///c:/Users/socce/software-lab/traffic-accident/results/analysis/optuna_study_history.csv)
- [ç‰¹å¾´é‡é‡è¦åº¦](file:///c:/Users/socce/software-lab/traffic-accident/results/analysis/optuna_feature_importance.csv)
