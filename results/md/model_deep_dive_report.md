# Stackingモデル詳細分析レポート

**分析実施日:** 2025年12月30日

## 1. はじめに

本レポートは、交通事故の死亡リスクを予測する「Stage 3 Stackingモデル」の挙動を深く理解するために実施した4つの分析（地理的エラー分析、モデル間不一致分析、SHAP特徴量分析、閾値シミュレーション）の結果をまとめたものです。

モデルの単なる精度指標（AccuracyやAUC）だけでなく、「どこで間違えているのか」「なぜその予測になったのか」「運用でどう使うべきか」を明らかにすることを目的としています。

---

## 2. 要約 (Executive Summary)

今回の分析により、モデルの特性と課題が明確になりました。

1.  **検出力の課題**: 現在の閾値（0.14）では、死亡事故の約 **29.4%** しか検知できておらず、**70%以上を見逃しています (False Negative)**。
2.  **安全性重視の運用**: 見逃しを減らし、Recall（検知率）を95%以上にするためには、閾値を **0.001** 付近まで極端に下げる必要があります。しかし、その場合アラート数が膨大（全データの約半数）になり、運用コストとのトレードオフが発生します。
3.  **モデル間の不一致**: ベースモデル（TabNetとCatBoost）の間で意見が割れるケースが **42%** 存在します。特にCatBoostが「安全」と判断し、TabNetが「危険」と判断するケースでのStackingモデルの判断傾向に特徴があります。
4.  **データリークの疑い**: 特徴量分析において、予測対象であるはずの一部の情報が学習データに含まれている可能性（Target Leakage）が示唆されました。これは早急な修正が必要です。

---

## 3. 詳細分析結果

### 3.1 地理的エラー分析 (Geospatial Error Analysis)

モデルが「どの場所で」予測を外しているかを地図上で分析しました。

*   **現状の精度**:
    *   **Recall (再現率)**: 29.41% - 死亡事故のうち、約3割しか正しく予測できていません。
    *   **Precision (適合率)**: 26.36% - アラートを出したもののうち、実際に死亡事故だったのは約4件に1件です。
    *   **見逃し (False Negative)**: 1,829件（注視すべき課題）

*   **エリア別の特徴**:
    *   エリアによって精度に大きなばらつきがあります。
    *   **ワーストエリア（ID: 11, 18, 49など）** では、Recallが **12〜14%** 程度に留まっており、特定の地域特性（例：山間部や特定の道路構造）をモデルが学習しきれていない可能性があります。
    *   一方で、一部のエリアでは高い検知率を示しており、モデルが得意な地域と苦手な地域がはっきりしています。

### 3.2 モデル間不一致分析 (Disagreement Analysis)

Stackingモデルを構成する2つの強力なベースモデル（TabNet, CatBoost）の判断の違いを分析しました。

*   **不一致率**: 42.0% の事例で、2つのモデルの予測結果（閾値判定）が異なっています。
    *   **Both Negative (両方とも安全)**: 57.1%
    *   **CatBoost Only (CatBoostのみ危険)**: 42.0%
    *   **Both Positive (両方とも危険)**: 0.9%
    *   **TabNet Only (TabNetのみ危険)**: 0.0%

*   **考察**:
    *   CatBoostの方が圧倒的に「危険」と判断する頻度が高い（攻撃的なモデル）傾向にあります。
    *   両方のモデルが「危険」と判断したケース（Both Positive / 2,605件）は、Stackingモデルでも **90.8%** という非常に高い確率で危険と判定されており、極めて信頼度の高いアラートと言えます。
    *   逆に、CatBoostだけが危険と判断したケースでのStackingのRecallは **5.8%** と低く、StackingモデルはTabNet（保守的な判断）の影響を強く受けているか、あるいは過剰検知を抑制する方向に働いている可能性があります。

### 3.3 SHAP特徴量分析 (Feature Importance)

> **✅ 修正完了**: 当初懸念されたTarget Leakage（`fatal`混入）は分析スクリプトの不備によるものであり、修正後の再分析で解消されました。モデルの健全性は確認済みです。

以下は、コードブック（データ定義書）に基づいて解読した、**「死亡事故を引き起こす具体的要因」** の詳細結果です。

#### 1. 当事者種別: 「大型トラック」の脅威
*   **危険因子**: `当事者種別コード 11` (**貨物車－大型車**)
*   **分析結果**: この特徴量のSHAP値は **+2.18** と突出して高く、全特徴量の中で最も危険なシグナルです。
*   **意味**: 第一当事者（過失割合が高い側）が大型トラックである場合、死亡事故になる確率は跳ね上がります。これは物理的なエネルギー差による必然的な結果と言えます。

#### 2. 車道幅員: 「巨大交差点」がデッドゾーン
*   **危険因子**: `車道幅員コード 19` (**交差点－大[13m以上]－大[13m以上]**)
*   **分析結果**: 最もリスクが高いのは単なる広い道路ではなく、「広い道路同士が交わる交差点」でした。
    *   コード `19` (大交差点) のSHAP値: **+0.91** (非常に危険)
    *   コード `01` (3.5m未満の単路) のSHAP値: **-0.99** (安全)
*   **意味**: 見通しが良くスピードが出やすい広幅員の交差点で、甚大な衝突事故（右直事故など）が発生していることを示唆します。

#### 3. 速度規制（相手方）: 「対歩行者・単独事故」の代理変数
*   **危険因子**: `速度規制コード 0` (**対象外当事者**)
*   **分析結果**: 「速度規制値 0」が極めて高いリスクを示していましたが、コードブックによればこれは「速度規制の対象外＝**相手方が歩行者、または相手なし（単独事故）**」を意味します。
*   **意味**: つまり、これは速度規制そのものの影響というより、「相手が車ではない（歩行者または壁などの工作物）」という状況自体が、死亡リスクの高さ（交通弱者の死亡、または自損死亡）を表しています。

#### 4. 事故履歴: 「魔の空白地帯」
*   **危険因子**: 過去1年間の事故件数が **0〜1件**
*   **分析結果**: 事故多発地点（Black Spot）よりも、普段事故が起きない場所での事故の方が致死率が高いことが再確認されました。
*   **意味**: ドライバーの油断、あるいはスピード超過が起きやすい「安全に見える場所」にこそ、致命的なリスクが潜んでいます。

#### 5. 時間帯: 「深夜の暴走」
*   **危険因子**: **0時〜4時**
*   **分析結果**: 深夜帯のリスク値が一貫してプラスを示しています。交通量減少による速度超過が主因と考えられます。

### 3.4 閾値シミュレーション (Threshold Simulation)

実運用において、どの「閾値（確率のしきい値）」を設定すべきかをシミュレーションしました。

*   **現状 (Threshold = 0.14)**:
    *   バランス重視の設定ですが、前述の通り7割の死亡事故を見逃しています。

*   **推奨シナリオ1: 命を守るための設定 (Recall 95%+)**
    *   **閾値**: **0.0010**
    *   **結果**: 97.3% の死亡事故を検知可能。
    *   **代償**: **142,888件** のアラートが発生します（全データの約半数）。
    *   **運用イメージ**: 全ての事故の半分に対して「危険」アラートが出るため、現場の負担は極めて大きくなりますが、見逃しは最小限になります。

*   **推奨シナリオ2: 効率重視の設定 (F1 Score Max)**
    *   **閾値**: **0.1500**
    *   **結果**: Recall 26.7%, Precision 28.2%
    *   **運用イメージ**: 確度の高いものだけに絞ってアラートを出しますが、多くの危険を見逃すリスクがあります。

---

## 4. 結論と提言

### モデル改善への提言
1.  **Target Leakageの修正**: 特徴量から `fatal` カラムを確実に除外し、モデルを再学習してください。これが最優先事項です。これを取り除くことで、真の重要な特徴量（道路幅員、時間帯など）が見えてくるはずです。
2.  **エリア特性の学習**: ワーストエリアのデータを重点的に分析し、その地域の特性（山間部、交差点構造など）を表す新たな特徴量を追加することを検討してください。

### 運用への提言
1.  **閾値の動的設定**: 一律の閾値ではなく、エリアや時間帯、あるいはリスク許容度に応じて閾値を調整する運用が望ましいです。
2.  **多段階アラート**:
    *   **Level 3 (High Danger)**: 両モデルが一致したケース（Top 0.9%）。即時介入が必要。
    *   **Level 2 (Medium Danger)**: Recall 95%基準。注意喚起レベル。
    *   というように、危険度に応じたアラート設計を推奨します。

---
*Report generated by Antigravity Agent*
