# 2段階モデル精度向上実験レポート

## 1. 実験背景と目的
### 背景
交通死亡事故予測において、ターゲット（死亡）とそれ以外（負傷・無傷）の比率は **1:118** という極端な不均衡状態にあります。
従来の単一段階モデル（RandomForest等）では、以下のジレンマがありました。
- **Recall（検知率）を優先**すると、大量の誤検知（False Positives）が発生し、Precision（適合率）が 0.04〜0.06 程度に低迷する。
- **Precisionを優先**すると、稀少な死亡事故を見逃してしまう（Recall低下）。

### 目的
**「死亡事故の見逃しをほぼゼロ（Recall 99%）にしつつ、誤検知を可能な限り減らす（Precision向上）」** ことを目指しました。
その解決策として、役割の異なる2つのモデルを直列に繋ぐ **「2段階カスケードモデル（Two-Stage Cascade Model）」** を導入・検証しました。

## 2. 実験内容
以下の2段階構成でパイプラインを構築しました。

### Stage 1: Candidate Generation（粗選別）
- **役割**: 明らかに安全なデータ（Safe Negative）をフィルタリングし、後段の負担を減らす。
- **手法**: **LightGBM + アンダーサンプリング (1:2)**
    - 負例をランダムに間引き、死者:その他 = 1:2 の比率で学習させ、モデルに「死亡事故」を強く意識させました。
    - **工夫**:
        - **Validationデータ**: 間引きなしの「現実世界の不均衡データ」を使用し、実環境での性能を保証。
        - **3-Seed Averaging**: サンプリングによるブレを防ぐため、3回の試行平均を使用。
        - **評価指標**: 不均衡に強い `AUC` を採用。
- **結果**: 閾値 0.04 で **Recall 99%** を維持しつつ、全データの **約25%** を除外することに成功。

### Stage 2: Fine-Grained Classification（精密検査）
- **役割**: Stage 1を通過した「死亡事故」と「紛らわしい負傷事故（Hard Negative）」を精密に識別する。
- **手法**: **LightGBM（高複雑度 + 強正則化）**
    - 難しい境界線を捉えるため、モデルの表現力を向上（`num_leaves`増、`min_child_samples`減）。
    - 過学習を防ぐため、正則化（L1/L2）を強力に適用。
- **特徴エンジニアリングの強化**:
    - **prob_stage1**: Stage 1の予測スコア（OOF予測）を追加し、前段の判断を伝達。
    - **Cat-Interaction**: 重要変数（警察署、地形など）の組み合わせを「複合カテゴリ」として追加。

## 3. 実験結果
ベースライン（Stage 1単独モデル）と比較し、劇的な精度向上が確認されました。

| 指標 | ベースライン | 最終パイプライン | 変化 |
|------|-------------|-----------------|------|
| **Precision** (適合率) | 0.0634 | **0.1888** | **+197.7% (約3倍)** |
| **Recall** (再現率) | 0.7130 | **0.9889** | **+38.7% (ほぼ100%)** |
| **F1-Score** | - | **0.3171** | - |

**結論**:
2段階モデルの導入により、**「死亡事故の99%を検知しながら、誤報を従来の約3分の1に減らす」** ことに成功しました。

## 4. 今後の提案
さらなる精度向上や実用化に向けて、以下の施策を提案します。

1.  **アンサンブル学習（Stacking）の導入**:
    - 現在は全てLightGBMですが、計算ロジックの異なる **XGBoost** や **CatBoost** をStage 2のバリエーションとして加え、それらを統合（Stacking）することで、さらなる精度向上が見込めます。

2.  **ハイパーパラメータの自動最適化 (Optuna)**:
    - 今回は手動で設定しましたが、**Optuna** を用いてパラメータを数学的に最適化することで、さらに数%の改善が期待できます。

3.  **誤検知（False Positive）の定性分析**:
    - Stage 2でも「死亡」と誤判定された事例（残り約80%）は、どのような特徴を持っているのか（例：特定の場所、天候、違反の種類）を詳細に分析し、新たな特徴量作成のヒントにします。
