# 交通事故予測モデル Focal Loss 実験最終レポート

**日付:** 2025年12月18日
**著者:** Antigravity (AI Agent)

## 1. エグゼクティブサマリ

交通事故の「重傷（死亡）」事例を高精度に検出するため、Stage 2モデルに **Focal Loss** を導入し、パラメータの最適化を行いました。

- **結論**: **手動調整モデル（Alpha=0.75, Gamma=1.0）が最高の性能** を示しました。
- **成果**: 
    - 従来のLog Lossと比較して、Precision（適合率）が **約30倍向上** しました。
    - **Recall 99%（見逃しほぼ無し）を維持しつつ、Precision 34.2% を達成**。
- **推奨**: 今後はこの手動調整モデルをベースラインとして採用し、運用フェーズへ進むことを推奨します。Optunaによる自動探索は設定の再考が必要です。

---

## 2. 実験結果詳細

### 実験1: パラメータ手動調整 (Alpha=0.75, Gamma=1.0)
Focal Lossの理論に基づき、正例（死亡事故）重視の設定を適用しました。

| 指標 | 値 | Baseline (Log Loss) 比 | 評価 |
| :--- | :--- | :--- | :--- |
| **Recall** | **99.0%** (固定) | ±0% | 目標達成 ✅ |
| **Precision** | **34.2%** | **+3110%** (1.1%→34.2%) | **劇的改善** 🚀 |
| **Score分布** | 0.001 ~ 0.95 | 全データ0.5付近 (初期) | 正常に分離 |

> **考察**: 
> `Alpha=0.75` により正例の勾配が強調され、`Gamma=1.0` により「易しい負例」の影響が適度に抑制されました。また、`boost_from_average=True`（デフォルト）により、不均衡データに適した初期値から学習がスタートできたことが成功の要因と考えられます。

### 実験2: Optunaによるパラメータ自動探索
さらなる性能向上を目指し、Alpha, Gamma およびLightGBMパラメータの広範囲探索を行いました。
技術的理由から `boost_from_average=False` を設定しました。

| 指標 | ベストスコア (Trial 2) | 実験1 (手動) との差 |
| :--- | :--- | :--- |
| **Recall** | 99.0% | ±0% |
| **Precision** | **1.38%** | **大幅劣化** 📉 (34.2% → 1.38%) |
| **ベストパラメータ** | Alpha=0.59, Gamma=0.70 | - |

> **失敗原因の分析**:
> Optunaの結果が手動設定を大きく下回りました。最大の要因は **`boost_from_average=False`** と推測されます。
> - 極端な不均衡データ（1:86）において、初期値を確率0.5（スコア0）で固定したため、モデルが初期の大きな損失を修正することにリソースを費やし、最適な分離境界を見つけられなかった可能性が高いです。
> - 勾配スケーリング等の工夫も行いましたが、初期値バイアスの欠如を補えませんでした。

---

## 3. 総合比較と結論

| モデル | Recall | Precision | 判定 |
| :--- | :--- | :--- | :--- |
| **Baseline (Log Loss)** | 99.0% | 1.1% | 実用不可 (誤検知多すぎ) |
| **Focal Loss (手動)** | **99.0%** | **34.2%** | **採用推奨 🏆** |
| **Focal Loss (Optuna)** | 99.0% | 1.38% | 設定見直しが必要 |

**結論:** 現時点では、**実験1（手動設定）のモデル構成がベスト** です。

---

## 4. 今後の展望

### 短期的なアクション (Next Steps)
1.  **ベストモデルの確定**: `Alpha=0.75, Gamma=1.0, boost_from_average=True` の設定でモデルを固定し、運用パイプラインを確立します。
2.  **インサイト分析**:
    -   手動設定モデルを用いて、**特徴量重要度 (Feature Importance)** を分析し、「Log Lossモデルが見ていなかったが、Focal Lossモデルが見つけた危険因子」を特定します。
    -   **誤検知 (High Confidence FP)** の事例を抽出し、現場の感覚（ヒヤリハット等）と合致するか定性評価を行います。

### 中長期的な課題
-   **Optuna再挑戦**: `boost_from_average=True` に戻し、かつ探索範囲を絞った上で再度最適化を試みます。
-   **特徴量エンジニアリング**: Focal Lossが得意とする「際どい事例」を判別するための、より詳細な特徴量（事故現場の幾何学的特徴など）の追加を検討します。
