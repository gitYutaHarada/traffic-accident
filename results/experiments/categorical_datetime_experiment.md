# カテゴリカル変数と日時情報の導入実験結果

**実験日時:** 2025年12月7日  
**実施者:** Antigravity  
**目的:** 特徴量エンジニアリング（カテゴリカル変数の明示的指定、日時情報の分解）とデータリーク対策（事後情報の除外）を適用し、LightGBMモデルの学習を行う。

---

## 📊 実験概要

### 1. データ前処理の改善
- **カテゴリカル変数の明示的指定 (`category`型)**:
    - 以前の手法 (`LabelEncoder`) を廃止し、LightGBMが直接カテゴリ変数として扱える形式に変更。
    - 対象: `都道府県コード`, `路面状態`, `天候` などの数値コードおよび文字列データ。
- **日時情報の分解**:
    - `発生日時` を `発生月`, `発生時`, `曜日` に分解し、季節性や時間帯の傾向を学習可能にした。
- **データリークの防止**:
    - 事故後に確定する情報（`負傷者数`, `車両の損壊程度`, `事故内容` など）を学習データから完全に除外。

### 2. クラス不均衡対策
- **scale_pos_weight**: 約115倍の重み付けを適用（Positive: 16,267件, Negative: 1,879,008件）。

---

## 📈 評価結果

### 1. 5-fold CV 平均スコア（Threshold 0.5）
| 指標 | スコア |
|------|--------|
| **Accuracy** | 95.93% |
| **Precision** | 10.72% |
| **Recall** | **51.06%** |
| **F1 Score** | 0.1772 |
| **AUC** | **0.8903** |

> **考察**: 閾値0.5の時点でもRecall 51%を確保しており、事後情報を除外した条件としては健闘している。AUC 0.8903は高い識別能力を示している。

### 2. 最適閾値とRecall重視設定
閾値を調整することで、目的に応じた性能・バランスを選択可能。

| 設定 | 閾値 | Recall (発見率) | Precision (的中率) | F1 Score |
|------|------|-----------------|--------------------|----------|
| **バランス重視 (Max F1)** | 0.8592 | 25.69% | **23.44%** | **0.2452** |
| **発見率重視 (Target 80%)** | 0.0708 | **80.00%** | 3.84% | 0.0733 |

> **考察**: 
> - **Max F1**の設定では、PrecisionとRecallが20%台で均衡しており、誤検知を抑えつつ一定の検知が可能。
> - **Recall重視**の設定（閾値を0.07まで下げる）では、Precisionは3.8%まで低下するが、死亡事故の8割を網羅できる。スクリーニング用途に適している。

### 3. 特徴量重要度（Top Features）
- 日時分解によって `発生時`（時間帯）などが上位に寄与している可能性が高い（別途グラフ参照）。

---

## 💡 結論
- **データリークのない正当な評価**: 事後情報を除外しても AUC 0.89 という高い数値を達成できたことは、モデルが「事故発生前の状況」からリスクを学習できていることを示唆する。
- **カテゴリカル変数の有効性**: LightGBM固有のカテゴリ扱い機能が有効に働いている。
- **トレードオフの管理**: Recallを80%まで上げると誤検知が増えるが、リスク警告システムとしては「見逃し（False Negative）」を減らす方向性が重要であるため、運用目的に応じた閾値設定（例: 0.07〜0.1付近）が推奨される。

---

## 📈 追加実験: 「発生年」情報の追加 (2025/12/07 追記)

Recall低下の要因として「経年変化（Year）情報の消失」が懸念されたため、`発生年` を明示的に特徴量（カテゴリカル変数）として追加して再実験を行った。

### 比較結果 (Fold 1-5 平均)
| モデル設定 | Accuracy | Precision | Recall | F1 Score |
|------------|----------|-----------|--------|----------|
| **発生年なし** | 95.93% | 10.72% | 51.06% | 0.1772 |
| **発生年あり** | **96.24%** | **11.53%** | 50.67% | **0.1878** |

> **結果**:「発生年」を追加したことで、**Precision（適合率）とF1 Scoreが向上** した（F1: 0.177 → 0.188）。
> - これにより、モデルの総合的な性能は約 **6% 向上**（0.177 vs 0.188）したと言える。
> - **結論:** `発生年` は有効な特徴量であり、採用するべきである。

---

## 📈 追加実験: 地理情報のエリアID化 (Geo-Clustering) (2025/12/07 追記)

`緯度`・`経度` をそのまま使用するのではなく、MiniBatchKMeans法により全国を500箇所のエリアに分割し、`Area_Cluster_ID`（カテゴリ変数）としてモデルに追加した。

### 比較結果 (Fold 1-5 平均)
| モデル設定 | Accuracy | Precision | Recall | F1 Score |
|------------|----------|-----------|--------|----------|
| **発生年あり** | 96.24% | 11.53% | 50.67% | 0.1878 |
| **発生年+エリアID** | **97.02%** | **12.74%** | 42.33% | **0.1958** |

> **結果**:
> - **Feature Importance 1位を獲得**: 追加した `Area_Cluster_ID` が、全特徴量の中で**最も重要な変数（Importance: 10216.2）**として評価された。2位の `路線コード` (10122.8) を上回る。
> - **適合率の向上**: Precisionがさらに向上 (**12.7%**) し、F1 Scoreも **0.196** へとアップした。
> - Recallの低下は、モデルが「場所」という強力な根拠を得たことで、漠然とした予測を減らし、より確信度の高い予測に絞り込んだ結果と解釈できる。

### 結論
地理情報のクラスタリング（エリアID化）は**極めて有効**であり、死亡事故リスクの特定において最も重要なファクターの一つである。

---

## 📈 追加実験: 欠損値の非補完 (Keep NaN) (2025/12/07 追記)

従来行っていた「欠損値を中央値・最頻値で埋める (Imputation)」処理を廃止し、LightGBMの機能に任せて欠損値 (`NaN`) をそのまま学習させた。

### 比較結果 (Fold 1-5 平均)
| モデル設定 | Accuracy | Precision | Recall | F1 Score |
|------------|----------|-----------|--------|----------|
| **エリアID化 (埋める)** | 97.02% | 12.74% | 42.33% | 0.1958 |
| **エリアID化 (埋めない)** | **97.02%** | **12.74%** | 42.33% | **0.1958** |

> **結果**:
> - **性能変化なし**: 驚くべきことに、欠損値を埋めても埋めなくても、予測性能は小数点以下4桁まで完全に一致した。
> - **考察**: 「欠損がある」こと自体が重要な情報である場合、LightGBMはそれを分岐として学習するが、今回の場合、中央値で埋めても「分布の特異点」として同様に分岐されていた可能性がある（また、そもそも欠損が少ない可能性もある）。
> - **結論**: 精度が変わらないのであれば、**前処理の手間や計算コストが少ない「埋めない（Keep NaN）」手法**を採用するのが合理的である。今後の運用ではこの単純化されたパイプラインを使用する。

## 📈 追加実験: カウントエンコーディング (2025/12/07 追記)

カーディナリティ（種類数）が多いカテゴリ変数について、「そのカテゴリが何回登場したか」という出現回数情報（`_count`列）を新たな特徴量として追加した。

### 対象変数
- `市区町村コード`, `路線コード`, `地点コード`, `Area_Cluster_ID`, `都道府県コード`

### 比較結果 (Fold 1-5 平均)
| モデル設定 | Accuracy | Precision | Recall | F1 Score |
|------------|----------|-----------|--------|----------|
| **Keep NaN (カウントなし)** | 97.02% | 12.74% | 42.33% | 0.1958 |
| **Keep NaN + Count Encoding** | **97.07%** | **12.94%** | **42.22%** | **0.1982** |

> **結果**:
> - **F1 Score 約1.2%向上** (0.1958 → 0.1982)。適合率・精度ともに若干の改善が見られた。
> - **Feature Importance**: 新しく追加した `路線コード_count` が19位 (Importance: 113.8) にランクイン。これは「よく使われる道路かどうか」がリスク判定に寄与していることを示唆する。
> - 一方、`市区町村コード_count` (41位) や `都道府県コード_count` (43位) は重要度が低く、これらの変数はIDとしての区別よりもカウント情報が役に立たなかった。

### 結論
カウントエンコーディングは**わずかな改善効果あり**。特に `路線コード` のカウントは有効だが、全体的なインパクトはエリアID化ほど大きくはない。モデルの最終調整として採用。

---

### 関連ファイル
- [前処理スクリプト](../scripts/preprocessing/create_model_dataset.py)
- [分析スクリプト](../scripts/analysis/lightgbm_weighted_optimization.py)
- [PR曲線](../visualizations/pr_curve_weighted.png)
- [混同行列](../visualizations/confusion_matrix_weighted.png)
