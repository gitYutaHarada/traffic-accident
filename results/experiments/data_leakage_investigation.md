# データリーク検証レポート

**検証日時:** 2025年12月8日  
**検証者:** Antigravity  
**目的:** Optunaチューニング結果の異常な高性能がデータリークに起因するか検証

---

## ⚠️ 検証結果: **重大なデータリークを確認**

### 問題の核心

**「事故内容」列がターゲット変数「死者数」と完全に相関している**

| 事故内容 | 死者数=0 | 死者数=1 | 合計 |
|---------|----------|----------|------|
| 1 (死亡) | **0** | **16,266** | 16,266 |
| 2 (負傷) | **1,879,008** | **1** | 1,879,009 |

> [!CAUTION]
> **完璧な予測変数**: 「事故内容=1(死亡)」は、ほぼ100%の精度で「死者数=1」を予測します。これは事故発生**後**に記録される情報であり、予測モデルには使用できません。

---

## 🔍 詳細調査

### 1. Codebookの定義（codebook_2024_extracted.txt）

```
項目名 事故内容
コード 区分
1 死亡    - 交通事故発生から24時間以内に死者を出した交通事故
2 負傷    - 治療を要する負傷者を出した交通事故
```

**致命的な問題**: この列は事故の**結果**を示しており、事故発生時には存在しない事後情報です。

### 2. スクリプトの除外リスト

[lightgbm_optuna_tuning.py](file:///c:/Users/socce/software-lab/traffic-accident/scripts/analysis/lightgbm_optuna_tuning.py) (72-81行目):

```python
drop_cols = [
    "資料区分", "本票番号",
    "人身損傷程度(当事者A)", "人身損傷程度(当事者B)",  # ← カッコが全角
    "車両の損壊程度(当事者A)", "車両の損壊程度(当事者B)",
    "負傷者数",
    "車両の衝突部位(当事者A)", "車両の衝突部位(当事者B)",
    "エアバッグの装備(当事者A)", "エアバッグの装備(当事者B)",
    "サイドエアバッグの装備(当事者A)", "サイドエアバッグの装備(当事者B)",
    "事故内容",  # ← リストに含まれている！
]
```

### 3. 実際のデータ列名

実際の`honhyo_model_ready.csv`の列名:
```
事故内容  ← 存在する！
人身損傷程度（当事者A）  ← カッコが「（」（全角）
人身損傷程度（当事者B）
...
```

> [!WARNING]
> **括弧の不一致**: スクリプトでは `(` (半角) を使用していますが、実際のデータ列名は `（` (**全角**) です。そのため、`errors='ignore'`により除外が**スキップ**され、これらの列がモデルに残りました。

---

## 📊 影響範囲の分析

### データリークしている列（実際にモデルで使用されている）

| 列名 | リーク度 | 理由 |
|------|----------|------|
| **事故内容** | **🔴 極めて高** | 死者数と100%相関 |
| **人身損傷程度（当事者A）** | **🔴 極めて高** | 死亡・重傷・軽傷を示す事後情報 |
| **人身損傷程度（当事者B）** | **🔴 極めて高** | 同上 |
| 車両の損壊程度（当事者A） | 🟡 中 | 事故の重大性と相関 |
| 車両の損壊程度（当事者B） | 🟡 中 | 同上 |
| 車両の衝突部位（当事者A） | 🟠 低~中 | 事故後に確認される情報 |
| 車両の衝突部位（当事者B） | 🟠 低~中 | 同上 |

### モデル性能への影響

```
予測される実際の性能（データリーク除去後）:
- Recall: 95.9% → 推定 10-30%
- Precision: 55.1% → 推定 5-20%
- F1 Score: 0.700 → 推定 0.1-0.3
```

---

## 🛠️ 修正方法

### 1. 列名の完全一致による除外

```python
drop_cols = [
    "資料区分", "本票番号",
    "人身損傷程度（当事者A）",  # 全角カッコに修正
    "人身損傷程度（当事者B）",
    "車両の損壊程度（当事者A）",
    "車両の損壊程度（当事者B）",
    "負傷者数",
    "車両の衝突部位（当事者A）",
    "車両の衝突部位（当事者B）",
    "エアバッグの装備（当事者A）",
    "エアバッグの装備（当事者B）",
    "サイドエアバッグの装備（当事者A）",
    "サイドエアバッグの装備（当事者B）",
    "事故内容",  # ← これが最も重要
]
```

### 2. 除外の検証

```python
# 除外後に確認
remaining_cols = df_clean.columns.tolist()
for col in drop_cols:
    if col in remaining_cols:
        raise ValueError(f"列 '{col}' が除外されていません！")
```

---

## 📌 結論と推奨事項

> [!IMPORTANT]
> **結論**: 報告された高性能（Recall 95.9%, Precision 55.1%）は、データリークによる**虚偽の結果**です。モデルは事故の結果を見て予測していたため、実用性はありません。

### 必須アクション

1. **即座にスクリプトを修正**: 全角括弧に対応
2. **再実験の実施**: データリーク除去後の真の性能を測定
3. **既存レポートの訂正**: `optuna_tuning_experiment.md`に警告を追加

### 今後の対策

- データ前処理時に列名の完全一致を確認
- 除外後にassertionで検証
- テストデータでの性能確認を必須化

---

## 🔗 関連ファイル

- [問題のスクリプト](file:///c:/Users/socce/software-lab/traffic-accident/scripts/analysis/lightgbm_optuna_tuning.py)
- [Codebook](file:///c:/Users/socce/software-lab/traffic-accident/data/codebook/codebook_2024_extracted.txt)
- [無効化されたレポート](file:///c:/Users/socce/software-lab/traffic-accident/results/experiments/optuna_tuning_experiment.md)
