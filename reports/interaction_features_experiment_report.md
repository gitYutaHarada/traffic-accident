# 交互作用特徴量実験 総合レポート

**実験期間**: 2025年12月11日  
**総評価時間**: 約3.2時間  
**評価対象**: 465個の交互作用特徴量  
**データセット**: `honhyo_clean_predictable_only.csv` (1,895,275件)

---

## エグゼクティブサマリー

交通事故死者予測モデルの精度向上を目的として、465個の交互作用特徴量を体系的に評価しました。LightGBMによる5-fold交差検証を用いてPR-AUCを評価指標とし、各交互作用特徴量の有効性を検証しました。

### 主要な発見

| 項目 | 結果 |
|------|------|
| **評価特徴量数** | 465個 |
| **PR-AUC向上** | 27個 (5.8%) |
| **PR-AUC低下** | 438個 (94.2%) |
| **最大改善度** | +0.0667 (+6.67%) |
| **ベースラインPR-AUC** | 0.1433 |

### 重要な知見

1. **当事者種別（当事者A）が鍵**: Top 11の交互作用特徴量のうち10個が「当事者種別（当事者A）」を含んでいます
2. **カテゴリカル×カテゴリカルが有効**: 向上した27個のうち、25個がcat_x_cat型の交互作用です
3. **数値型交互作用は効果が限定的**: num_x_cat型とnum_x_num型はすべてPR-AUCを低下させました

---

## 実験の背景と目的

### 背景

交通事故死者予測モデルにおいて、単一特徴量では捉えきれない複雑な関係性が存在する可能性があります。例えば：

- 「事故類型」と「車両の種類」の組み合わせ
- 「時間帯」と「道路状況」の相互作用
- 「天候」と「運転者の属性」の複合効果

これらの交互作用を明示的にモデルに組み込むことで、予測精度の向上が期待できます。

### 目的

1. **体系的評価**: すべての有望な交互作用特徴量を生成し、その効果を定量的に評価
2. **最適な組み合わせの発見**: PR-AUCを最大化する交互作用特徴量を特定
3. **実装の指針**: 実際にモデルに組み込むべき特徴量の優先順位を決定

---

## 実験手法

### 1. 交互作用特徴量の生成

**対象特徴量**: 
- カテゴリカル変数: 17個
- 数値変数: 14個

**生成タイプ**:
- `cat_x_cat`: カテゴリカル × カテゴリカル (276個)
- `num_x_cat`: 数値 × カテゴリカル (168個)
- `num_x_num`: 数値 × 数値 (21個)

**生成ロジック**:
- カテゴリカル×カテゴリカル: 値を結合して新しい複合カテゴリを作成
- 数値×カテゴリカル: 数値をカテゴリで層別化
- 数値×数値: 乗算による新しい数値特徴量

### 2. 評価プロトコル

**モデル**: LightGBM (最適化済みハイパーパラメータ使用)  
**交差検証**: 5-fold Stratified K-Fold  
**評価指標**: PR-AUC (Primary), ROC-AUC, F1スコア (Secondary)  
**ベースライン**: 交互作用特徴量なしのモデル

**評価方法**:
1. ベースラインモデルの性能を測定
2. 各交互作用特徴量を1つずつ追加してモデルを訓練
3. ベースラインとの差分（Delta PR-AUC）を計算
4. すべての特徴量をランク付け

---

## 実験結果

### Top 10 交互作用特徴量

| ランク | 特徴量名 | タイプ | Delta PR-AUC | PR-AUC | 改善率 |
|--------|---------|--------|--------------|--------|--------|
| 1 | `事故類型_x_当事者種別（当事者A）` | cat_x_cat | +0.0667 | 0.2101 | +6.67% |
| 2 | `当事者種別（当事者A）_x_祝日(発生年月日)` | cat_x_cat | +0.0665 | 0.2099 | +6.65% |
| 3 | `当事者種別（当事者A）_x_曜日(発生年月日)` | cat_x_cat | +0.0660 | 0.2093 | +6.60% |
| 4 | `当事者種別（当事者A）_x_速度規制（指定のみ）（当事者A）` | cat_x_cat | +0.0659 | 0.2092 | +6.59% |
| 5 | `当事者種別（当事者A）_x_歩車道区分` | cat_x_cat | +0.0655 | 0.2088 | +6.55% |
| 6 | `当事者種別（当事者A）_x_衝突地点` | cat_x_cat | +0.0652 | 0.2085 | +6.52% |
| 7 | `当事者種別（当事者A）_x_路面状態` | cat_x_cat | +0.0647 | 0.2080 | +6.47% |
| 8 | `用途別（当事者A）_x_道路線形` | cat_x_cat | +0.0645 | 0.2078 | +6.45% |
| 9 | `当事者種別（当事者A）_x_道路線形` | cat_x_cat | +0.0644 | 0.2077 | +6.44% |
| 10 | `当事者種別（当事者A）_x_速度規制（指定のみ）（当事者B）` | cat_x_cat | +0.0643 | 0.2077 | +6.43% |

### 交互作用タイプ別の分析

| タイプ | 評価数 | 向上数 | 向上率 | 平均Delta PR-AUC | 標準偏差 | 最小値 | 最大値 |
|--------|--------|--------|--------|------------------|----------|--------|--------|
| **cat_x_cat** | 276 | 27 | 9.8% | -0.0296 | 0.0258 | -0.0579 | **+0.0667** |
| **num_x_cat** | 168 | 0 | 0.0% | -0.0363 | 0.0054 | -0.0516 | -0.0177 |
| **num_x_num** | 21 | 0 | 0.0% | -0.0374 | 0.0057 | -0.0476 | -0.0265 |

**分析**:
- カテゴリカル×カテゴリカルの交互作用のみが効果的
- 数値型を含む交互作用は、モデルの複雑性を増すだけで精度向上には寄与しない
- これは決定木ベースのモデル（LightGBM）が数値型の交互作用を自動的に学習できるため

---

## 詳細分析

### 最良の交互作用: `事故類型_x_当事者種別（当事者A）`

**組み合わせ**: `事故類型` × `当事者種別（当事者A）`

**性能指標**:
- **PR-AUC**: 0.2101 (ベースライン: 0.1433)
- **ROC-AUC**: 0.8914 (+0.0194)
- **F1スコア**: 0.2436 (+0.1060)
- **Accuracy**: 0.9758
- **Precision**: 0.1665
- **Recall**: 0.4544

**特徴**:
- ユニーク値数: 93
- 欠損率: 0.0%

**解釈**:
この交互作用は「どのような事故（正面衝突、追突など）」と「誰が関与したか（歩行者、二輪車、乗用車など）」の組み合わせを表現します。例えば：
- 「正面衝突 × 二輪車」は高リスク
- 「追突 × 乗用車」は比較的低リスク

このような複合的なパターンを明示的にモデルに与えることで、死亡リスクの予測精度が大幅に向上しました。

### 「当事者種別（当事者A）」の重要性

Top 11の交互作用特徴量のうち、**10個が「当事者種別（当事者A）」を含んでいます**。これは以下を示唆します：

1. **車両・歩行者の種類は死亡リスクの最重要因子**: 二輪車、歩行者、自転車は死亡リスクが高い
2. **文脈依存性**: 同じ車両種別でも、事故の状況（時間帯、天候、道路状況など）によってリスクが大きく変動
3. **交互作用の必要性**: 単独では捉えきれない複雑なリスクパターンが存在

### PR-AUCを低下させた交互作用の特徴

**都道府県コードを含む交互作用**:
- 28位の`地形_x_用途別（当事者A）`以降、都道府県コードを含む交互作用が多数ランクインしていますが、すべてPR-AUCを低下させています
- これは地域的な偏りを過度に学習し、汎化性能が低下したためと考えられます

**数値型交互作用**:
- 緯度・経度との交互作用は一貫してPR-AUCを低下
- これら地理的情報は既に都道府県コードや市区町村コードに含まれており、冗長性が高いと推測されます

---

## 既存実験との比較

### 実験1: 手動設計のクロス特徴量（5個）

過去に実施された実験では、ドメイン知識に基づいて5つの交互作用特徴量を手動で設計しました：

1. `interaction_type_speed` (車種 × 速度規制)
2. `interaction_age_hour` (年齢 × 時間帯)
3. `interaction_terrain_shape` (地形 × 道路形状)
4. `interaction_area_daynight` (エリアID × 昼夜)
5. `interaction_weather_road` (天候 × 路面状態)

**結果**:
- AUC (平均): 0.8871 (ベースライン: 0.8876) **📉 -0.0005**
- Recall (平均): 0.7381 (ベースライン: 0.7567) **📉 -0.0186**

**分析**:
手動で設計した交互作用は特徴量重要度では上位にランクインしたものの、モデル全体の精度は悪化しました。これは：
- 過学習の懸念
- 適切でない組み合わせの選択
- 複雑性の増加によるノイズの影響

### 実験2: 体系的評価（465個）

今回の実験では、すべての有望な交互作用を網羅的に評価しました：

**結果**:
- 最良のPR-AUC: 0.2101 (ベースライン: 0.1433) **✅ +0.0667 (+46.6%)**
- 効果的な交互作用: 27個を発見

**比較から得られた知見**:
1. **体系的アプローチの重要性**: 直感だけでなく、データドリブンな評価が必要
2. **当事者情報の重要性**: 手動実験では「当事者種別」の交互作用が不足していた
3. **単一追加評価の有効性**: 複数の交互作用を同時に追加すると相互干渉が発生する可能性

---

## 推奨事項と次のステップ

### 即座に実装すべき施策

#### 1. Top 3 交互作用特徴量の追加

**推奨する特徴量**:
1. `事故類型_x_当事者種別（当事者A）` (Delta PR-AUC: +0.0667)
2. `当事者種別（当事者A）_x_祝日(発生年月日)` (Delta PR-AUC: +0.0665)
3. `当事者種別（当事者A）_x_曜日(発生年月日)` (Delta PR-AUC: +0.0660)

**期待される効果**:
- PR-AUCの大幅な向上（単一追加で+6.5%以上）
- 死亡事故検出率の改善

**実装手順**:
1. 交互作用特徴量を生成
2. LightGBMモデルを再訓練
3. 5-fold CVで性能を検証
4. 本番環境にデプロイ

#### 2. 段階的な特徴量追加

一度に複数の交互作用を追加すると、相互干渉や過学習のリスクがあります。以下の手順を推奨します：

**ステップ1**: Top 1のみを追加してベースラインを更新
**ステップ2**: Top 2-3を追加して効果を検証
**ステップ3**: Top 4-10を1つずつ追加し、限界効用を評価

### 中長期的な施策

#### 3. 特徴量選択の最適化

**手法**:
- **前向き選択法**: Top 1から順に追加し、PR-AUCが向上する限り追加を継続
- **遺伝的アルゴリズム**: 複数の交互作用の最適な組み合わせを探索
- **LASSO正則化**: L1正則化により自動的に不要な交互作用を除外

#### 4. ドメイン知識との統合

統計的に有効と判断された交互作用が、ドメイン専門家の知見と一致するか検証します：

**検証項目**:
- 「事故類型 × 当事者種別」は直感的に理解できるか？
- 「祝日 × 当事者種別」のリスクパターンは合理的か？
- 予期しない組み合わせがある場合、その原因を調査

#### 5. 他のモデルでの検証

LightGBM以外のモデルでも同様の効果が得られるか検証します：

- XGBoost
- Random Forest
- ニューラルネットワーク（交互作用の自動学習）

#### 6. 3次以上の交互作用の探索

今回は2次の交互作用（2つの特徴量の組み合わせ）のみを評価しましたが、3次以上の複雑な交互作用も存在する可能性があります：

例: `事故類型 × 当事者種別 × 天候`

ただし、計算コストと解釈可能性のトレードオフに注意が必要です。

---

## 技術的詳細

### 実験環境

- **Python**: 3.14
- **LightGBM**: 5.0.0
- **評価時間**: 約3.2時間（465個の交互作用を評価）
- **計算リソース**: ローカルPC

### データ仕様

- **データセット**: `honhyo_clean_predictable_only.csv`
- **サンプル数**: 1,895,275件
- **目的変数**: 死者数（二値分類: 0=死者なし, 1=死者あり）
- **クラス不均衡**: 約1:61（死者あり:死者なし）

### 生成ファイル

| ファイル名 | 説明 | パス |
|-----------|------|------|
| ランキングCSV（全件） | 465個すべての評価結果 | [`interaction_features_ranking_full_20251211_181555.csv`](file:///c:/Users/socce/software-lab/traffic-accident/results/interaction_features/interaction_features_ranking_full_20251211_181555.csv) |
| ランキングCSV（Top100） | 上位100件の詳細データ | [`interaction_features_ranking_top100_20251211_181555.csv`](file:///c:/Users/socce/software-lab/traffic-accident/results/interaction_features/interaction_features_ranking_top100_20251211_181555.csv) |
| Markdownレポート | 詳細分析レポート | [`interaction_features_ranking_report.md`](file:///c:/Users/socce/software-lab/traffic-accident/results/interaction_features/interaction_features_ranking_report.md) |
| 棒グラフ | Top20の可視化 | [`top20_bar_chart.png`](file:///c:/Users/socce/software-lab/traffic-accident/results/interaction_features/top20_bar_chart.png) |
| ヒートマップ | Top30の相関分析 | [`top30_heatmap.png`](file:///c:/Users/socce/software-lab/traffic-accident/results/interaction_features/top30_heatmap.png) |
| 分布プロット | Delta PR-AUCの分布 | [`distribution_plots.png`](file:///c:/Users/socce/software-lab/traffic-accident/results/interaction_features/distribution_plots.png) |

### 再現手順

```bash
# 全パイプラインを実行
python scripts/feature_engineering/run_interaction_analysis.py

# 既存の交互作用特徴量を使用して評価のみ実行
python scripts/feature_engineering/run_interaction_analysis.py \
  --skip-generation \
  --interaction-dir data/interaction_features_20251211_150251
```

---

## 結論

本実験により、**交互作用特徴量は適切に選択すれば大幅な精度向上をもたらす**ことが実証されました。特に：

1. **「当事者種別（当事者A）」を含む交互作用が最も効果的**
2. **カテゴリカル×カテゴリカルの組み合わせに注力すべき**
3. **体系的評価により、直感では見つけにくい有効な交互作用を発見**

今後、Top 3の交互作用特徴量をモデルに統合することで、死亡事故の予測精度を大幅に向上させることが期待できます。これにより、交通安全施策のより効果的な立案と実施が可能になります。

---

**レポート作成日**: 2025年12月12日  
**作成者**: Antigravity AI Agent  
**実験担当**: 交互作用特徴量分析パイプライン
