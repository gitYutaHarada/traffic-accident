# アソシエーション分析実行ガイド

## 概要

このガイドでは、交通事故データに対してアソシエーション分析を実行し、**死亡事故に繋がる要因**を発見する方法を説明します。

## 分析の目的

Aprioriアルゴリズムを用いて、以下のような関連ルールを抽出します:
- 死亡事故と強く関連する環境要因(天候、時間帯、道路状況など)
- 死亡事故につながる複数要因の組み合わせパターン
- 高齢者や特定の当事者種別と死亡事故の関連性

## 実行方法

### 方法1: バッチファイルで一括実行(推奨)

```bash
run_association_analysis.bat
```

このバッチファイルは以下の処理を順次実行します:
1. データ前処理
2. アソシエーション分析
3. 結果の可視化

### 方法2: 個別にスクリプトを実行

#### 1. データ前処理

```bash
python scripts\association_analysis\preprocess_for_association.py
```

**処理内容:**
- 死亡事故フラグの作成(死者数 > 0)
- 年齢を年代に変換
- 時間帯の区分化
- トランザクション形式への変換

**出力:**
- `results/association_analysis/transactions_all.csv`: 全データのトランザクション
- `results/association_analysis/transactions_fatal.csv`: 死亡事故のみのトランザクション
- `results/association_analysis/preprocessing_stats.csv`: 前処理統計情報

#### 2. アソシエーション分析

```bash
python scripts\association_analysis\run_association_analysis.py
```

**パラメータ:**
- 最小支持度 (min_support): 0.01 (1%)
- 最小確信度 (min_confidence): 0.3 (30%)
- 最小リフト値 (min_lift): 1.2

**出力:**
- `results/association_analysis/frequent_itemsets.csv`: 頻出アイテムセット
- `results/association_analysis/association_rules.csv`: 全ルール
- `results/association_analysis/fatal_accident_rules.csv`: 死亡事故関連ルール
- `results/association_analysis/top_fatal_accident_rules.csv`: 上位50ルール
- `results/association_analysis/fatal_only_rules.csv`: 死亡事故のみのルール

#### 3. 結果の可視化

```bash
python scripts\association_analysis\visualize_association_rules.py
```

**出力:**
- `fatal_scatter_plot.png`: Support-Confidence散布図
- `fatal_lift_ranking.png`: Lift値ランキング
- `fatal_metrics_comparison.png`: 評価指標比較
- `fatal_condition_frequency.png`: 頻出する条件要素
- `fatal_only_scatter_plot.png`: 死亡事故のみの散布図
- `fatal_only_lift_ranking.png`: 死亡事故のみのランキング

## 実行時間の目安

- **データ前処理**: 5-10分
- **アソシエーション分析**: 10-20分(min_support=0.01の場合)
- **可視化**: 2-5分

**合計**: 約20-35分

## 結果の解釈

### 評価指標

1. **Support(支持度)**
   - ルールが全体に占める割合
   - 高いほどそのパターンが頻繁に発生

2. **Confidence(確信度)**
   - 条件が満たされた時に結果が発生する確率
   - 高いほど条件から結果への関連が強い

3. **Lift(リフト値)**
   - ルールの有用性を示す指標
   - 1より大きい: 正の相関
   - 1に近い: 独立
   - 1より小さい: 負の相関

### 結果ファイルの見方

#### `fatal_accident_rules.csv`

死亡事故に関連する全ルールが記載されています。

| 条件 | 結果 | Support | Confidence | Lift |
|------|------|---------|------------|------|
| 年代=70代以上, 時間帯=夜間 | 死亡事故=死亡事故あり | 0.0123 | 0.45 | 2.3 |

**解釈例:**
- 70代以上で夜間の事故は、全体の1.23%を占める
- この条件下では45%の確率で死亡事故が発生
- ランダムな場合と比べて2.3倍死亡事故が発生しやすい

## パラメータの調整

### 支持度を下げる場合

より詳細なルールを発見できますが、計算時間が増加します。

`run_association_analysis.py`の以下の行を編集:

```python
MIN_SUPPORT = 0.005  # 0.01から0.005に変更
```

### 確信度を上げる場合

より確実性の高いルールのみを抽出します。

```python
MIN_CONFIDENCE = 0.5  # 0.3から0.5に変更
```

## トラブルシューティング

### メモリ不足エラー

データサイズが大きい場合、メモリ不足が発生する可能性があります。

**対処法:**
1. 支持度を上げる(MIN_SUPPORT = 0.02など)
2. サンプリングを実施

### 実行時間が長すぎる

**対処法:**
1. 支持度を上げる
2. まず死亡事故のみのデータで試す

### ルールが見つからない

**対処法:**
1. 支持度を下げる
2. 確信度を下げる
3. リフト値を下げる

## 次のステップ

1. **結果の分析**: 上位ルールを確認し、意味のあるパターンを特定
2. **ドメイン知識との照合**: 交通安全の専門家と結果を検討
3. **施策への応用**: 発見されたパターンに基づく事故防止策の検討

## 参考

- 使用アルゴリズム: Apriori
- 使用ライブラリ: mlxtend
- データ: honhyo_clean_road_type.csv (約190万件)
