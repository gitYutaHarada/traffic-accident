# 地理情報クラスタリング手法ドキュメント

## 概要

本ドキュメントでは、`honhyo_clean_with_features.csv` における地理情報クラスタリング（`area_id`）の実装方法と結果について説明します。

---

## 1. 目的

交通事故発生地点の緯度経度情報を用いて、日本全国を**50の地理的クラスタ（エリア）**に分割し、各事故に対して所属エリアID（`area_id`）を付与することで、**地域特性**を機械学習モデルの特徴量として活用可能にする。

---

## 2. 入力データ

| 項目 | 値 |
|------|-----|
| 入力ファイル | `honhyo_clean_road_type.csv` |
| 出力ファイル | `honhyo_clean_with_features.csv` |
| レコード数 | 約 360,000 件 |
| 使用列 | `地点　経度（東経）`、`地点　緯度（北緯）` |

### 座標フォーマット

元データの緯度経度は**度分秒形式（DDDMMSSsss）**で格納されています。

```
例: 1393500000
    ↓
    139度 35分 00.000秒
    ↓
    139.5833... 度（10進数）
```

---

## 3. 処理フロー

```
┌─────────────────────────────────────────────────────────────────────┐
│  Step 1: 座標形式変換                                               │
│  度分秒形式（DDDMMSSsss）→ 10進数（度）                            │
└──────────────────────────────┬──────────────────────────────────────┘
                               ▼
┌─────────────────────────────────────────────────────────────────────┐
│  Step 2: 欠損値処理                                                 │
│  - 有効座標 → クラスタリング対象                                    │
│  - 欠損座標 → area_id = -1                                          │
└──────────────────────────────┬──────────────────────────────────────┘
                               ▼
┌─────────────────────────────────────────────────────────────────────┐
│  Step 3: MiniBatchKMeans クラスタリング                             │
│  - n_clusters = 50                                                  │
│  - 各事故地点にクラスタID（0〜49）を割り当て                         │
└──────────────────────────────┬──────────────────────────────────────┘
                               ▼
┌─────────────────────────────────────────────────────────────────────┐
│  Step 4: 出力                                                       │
│  - area_id 列を追加して CSV 保存                                    │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 4. 座標変換関数

```python
def convert_dms_to_deg(v):
    """度分秒形式（DDDMMSSsss）から10進数の度に変換"""
    v = np.where(v == 0, np.nan, v)
    ms = v % 1000          # ミリ秒
    v = v // 1000
    ss = v % 100           # 秒
    v = v // 100
    mm = v % 100           # 分
    dd = v // 100          # 度
    return dd + mm/60 + (ss + ms/1000)/3600
```

---

## 5. クラスタリングアルゴリズム

### 使用アルゴリズム: MiniBatchKMeans

| パラメータ | 値 | 説明 |
|-----------|-----|------|
| `n_clusters` | **50** | クラスタ数（エリア数） |
| `random_state` | 42 | 再現性確保のためのシード値 |
| `batch_size` | 4096 | ミニバッチサイズ |
| `n_init` | 10 | 初期化回数（最良結果を採用） |

### なぜ MiniBatchKMeans を選択したか

| 特徴 | MiniBatchKMeans | 通常のKMeans |
|------|-----------------|--------------|
| **処理速度** | 高速 ✅ | 低速 |
| **メモリ使用量** | 少ない ✅ | 多い |
| **大規模データへの適性** | 適している ✅ | 不向き |
| **精度** | やや劣る | 高い |

約36万件の事故データを効率的に処理するため、**MiniBatchKMeans** を採用しました。

### なぜ n_clusters = 50 としたか

事前実験（`optimize_area_granularity.py`）により、クラスタ数と予測性能の関係を検証しました。

| n_clusters | AUC | Recall |
|------------|-----|--------|
| 10 | 低い | 低い |
| **50** | **最適** | **最適** |
| 100 | やや低下 | やや低下 |
| 200以上 | 過学習傾向 | 過学習傾向 |

**n_clusters = 50** が AUC・Recall のバランスが最も良好でした。

---

## 6. 出力結果

### 6.1 area_id の仕様

| 値 | 意味 |
|----|------|
| 0〜49 | 有効なクラスタID |
| -1 | 座標欠損（クラスタリング不可） |

### 6.2 クラスタ別統計（上位10クラスタ）

| area_id | 事故件数 | 中心経度 | 中心緯度 | 推定エリア |
|---------|---------|---------|---------|-----------|
| 13 | 172,317件 | 136.91° | 35.13° | 愛知県・岐阜県周辺 |
| 4 | 127,263件 | 139.73° | 35.64° | 東京都心部 |
| 45 | 112,145件 | 135.46° | 34.67° | 大阪府 |
| 35 | 105,414件 | 139.49° | 35.42° | 神奈川県・埼玉県 |
| 21 | 103,950件 | 139.78° | 35.86° | 千葉県北部 |
| 16 | 96,571件 | 130.44° | 33.49° | 福岡県 |
| 46 | 87,633件 | 139.44° | 35.77° | 埼玉県 |
| 3 | 73,437件 | 135.63° | 34.75° | 京都府・滋賀県 |
| 11 | 69,195件 | 139.15° | 36.33° | 群馬県・栃木県 |
| 6 | 61,554件 | 137.68° | 34.75° | 静岡県 |

---

## 7. 可視化結果

### 7.1 日本全国マップ（クラスタ別色分け）

![日本全国のクラスタリング結果](images/geo_clusters_japan_map.png)

50,000件をサンプリングし、各事故地点を `area_id` ごとに色分けして表示しています。

### 7.2 クラスタ中心点マップ

![クラスタ中心点と事故件数](images/geo_clusters_centers.png)

- **円の中の数字**: クラスタID（`area_id`: 0〜49）
- **円の大きさ**: そのクラスタ内の事故件数に比例

### 7.3 主要都市圏の拡大図

![主要都市圏詳細](images/geo_clusters_regions.png)

関東・関西・東海の主要都市圏におけるクラスタリングの詳細を確認できます。

---

## 8. ファイル構成

| ファイル | 説明 |
|---------|------|
| `scripts/data_processing/add_derived_features.py` | クラスタリング実行スクリプト |
| `scripts/visualization/visualize_geo_clusters.py` | 可視化スクリプト |
| `data/processed/honhyo_clean_with_features.csv` | 出力データ（area_id含む） |
| `results/visualization/geo_clusters_*.png` | 可視化画像 |
| `results/visualization/geo_clusters_stats.csv` | クラスタ統計情報 |

---

## 9. 参考：実装コード

```python
from sklearn.cluster import MiniBatchKMeans

# パラメータ設定
N_CLUSTERS = 50

# 有効な座標のみ抽出
valid_coords = df[['lon_deg', 'lat_deg']].dropna()

# クラスタリング実行
kmeans = MiniBatchKMeans(
    n_clusters=N_CLUSTERS,
    random_state=42,
    batch_size=4096,
    n_init=10
)
cluster_labels = kmeans.fit_predict(valid_coords)

# area_id を割り当て
df['area_id'] = -1  # 初期値（欠損用）
df.loc[valid_coords.index, 'area_id'] = cluster_labels
```

---

## 10. まとめ

- **手法**: MiniBatchKMeans（K-Means の高速版）
- **クラスタ数**: 50
- **入力**: 緯度経度（度分秒形式 → 10進数変換）
- **出力**: `area_id`（0〜49）、欠損時は -1
- **目的**: 地理的特性を機械学習モデルの特徴量として活用

これにより、事故発生地点の「地域性」を考慮した予測モデルの構築が可能となります。
